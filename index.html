<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spooky AR Glasses | Halloween Magic</title>

    <!-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–Ü –°–ö–†–ò–ü–¢–ò -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    <!-- üì∏ html2canvas –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–Ω—ñ–º–∫–∞ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
        }

        /* –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á */
        #loading-screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(45deg, #1a0033, #33001a);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        .crystal-ball {
            width: 80px; height: 80px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #00ff88, #003322);
            margin: 0 auto 20px;
            animation: float 2s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(180deg); }
        }
        .loader p { color: #00ff88; font-size: 18px; margin-top: 10px; }

        /* AR –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #app-container {
            position: relative; width: 100vw; height: 100vh; display: none;
        }
        .ar-scene {
            width: 100% !important;
            height: 100% !important;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó */
        #task-canvas {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100; border: 2px solid #00ff88;
            border-radius: 10px; box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            max-width: 90%;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        #ui-controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 15px; z-index: 100;
        }
        .spooky-btn {
            background: linear-gradient(45deg, #ff4444, #ff8800);
            border: none; padding: 15px 25px; border-radius: 25px;
            color: white; font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3); transition: all 0.3s ease;
            display: none;
        }
        .spooky-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.5);
        }

        /* –ü—ñ–¥–∫–∞–∑–∫–∞ */
        #hint-message {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85); color: #00ff88;
            padding: 12px 24px; border-radius: 25px; border: 2px solid #00ff88;
            font-size: 14px; z-index: 100; text-align: center;
            backdrop-filter: blur(8px);
            display: none;
        }

        /* –°–ø–∞–ª–∞—Ö —Ñ–æ—Ç–æ */
        .flash {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: white;
            opacity: 0; z-index: 2000; pointer-events: none;
            transition: opacity 0.2s;
        }

        /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
        .message {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 30, 0, 0.9); color: #00ff00;
            padding: 20px 30px; border-radius: 20px; border: 2px solid #00ff00;
            font-size: 18px; text-align: center; z-index: 3000;
            max-width: 320px; box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
            animation: messageAppear 0.4s ease-out;
            white-space: pre-line;
        }
        @keyframes messageAppear {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* –ü—Ä–∏–≤–∏–¥–∏ —è–∫ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è */
        .ghost {
            position: absolute;
            pointer-events: none;
            z-index: 50;
            animation: ghostFloat 3s ease-in-out infinite;
        }

        @keyframes ghostFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg); 
            }
            50% { 
                transform: translateY(-20px) rotate(5deg); 
            }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader">
            <div class="crystal-ball"></div>
            <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞–≥—ñ—ó...</p>
        </div>
    </div>

    <div id="app-container">
        <a-scene 
            class="ar-scene"
            mindar-image="imageTargetSrc: ./assets/targets/3-markers.mind; autoStart: true; maxTrack: 3;"
            vr-mode-ui="enabled: false"
            device-orientation-permission-ui="enabled: false"
            embedded
        >
            <!-- üî• –ö–∞–º–µ—Ä–∞ –∑ –≤—ñ–¥–µ–æ –ø–æ—Ç–æ–∫–æ–º -->
            <a-camera active="true" position="0 0 0" look-controls="enabled: false">
                <a-video id="camera-video" src="#camera-stream" autoplay loop muted playsinline></a-video>
            </a-camera>

            <!-- üåç –§–æ–Ω –∑ –≤—ñ–¥–µ–æ –∫–∞–º–µ—Ä–∏ -->
            <a-entity>
                <a-plane 
                    width="16" height="9" 
                    rotation="-90 0 0" 
                    material="shader: flat; src: #camera-stream; side: double"
                ></a-plane>
            </a-entity>

            <!-- –ú–∞—Ä–∫–µ—Ä 1 -->
            <a-entity mindar-image-target="targetIndex: 0">
                <a-entity class="ghost-entity" data-ghost-id="1"></a-entity>
            </a-entity>

            <!-- –ú–∞—Ä–∫–µ—Ä 2 -->
            <a-entity mindar-image-target="targetIndex: 1">
                <a-entity class="ghost-entity" data-ghost-id="2"></a-entity>
            </a-entity>

            <!-- –ú–∞—Ä–∫–µ—Ä 3 -->
            <a-entity mindar-image-target="targetIndex: 2">
                <a-entity class="ghost-entity" data-ghost-id="3"></a-entity>
            </a-entity>
        </a-scene>

        <div id="ui-controls">
            <button id="photo-btn" class="spooky-btn">üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—É–≤–∞—Ç–∏</button>
            <button id="info-btn" class="spooky-btn">‚ÑπÔ∏è –Ü–Ω—Ñ–æ</button>
        </div>

        <div id="hint-message">–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –æ–¥–∏–Ω —ñ–∑ —Ç—Ä—å–æ—Ö –º–∞—Ä–∫–µ—Ä—ñ–≤...</div>
    </div>

    <div id="instructions" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 10px; z-index: 1000; text-align: center; max-width: 80%;">
        <h3 style="color: #00ff88;">–ê–ö–¢–ò–í–ê–¶–Ü–Ø –ü–†–ò–í–Ü–î–û–ë–ê–ß–ï–ù–ù–Ø</h3>
        <p>‚Ä¢ –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –æ–¥–∏–Ω —ñ–∑ —Ç—Ä—å–æ—Ö –º–∞—Ä–∫–µ—Ä—ñ–≤</p>
        <p>‚Ä¢ –ü—Ä–∏–≤–∏–¥–∏ –∑'—è–≤–ª—è—Ç—å—Å—è –Ω–∞–≤–∫–æ–ª–æ –º–∞—Ä–∫–µ—Ä—ñ–≤</p>
        <p>‚Ä¢ –†—É—Ö–∞–π—Ç–µ—Å—è –ø–æ–≤—ñ–ª—å–Ω–æ –¥–ª—è –∫—Ä–∞—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</p>
        <p>‚Ä¢ –ó–Ω–∞–π–¥—ñ—Ç—å –ø—Ä–∏–≤–∏–¥—ñ–≤ –Ω–∞ –≤—Å—ñ—Ö –º–∞—Ä–∫–µ—Ä–∞—Ö</p>
        <button id="start-btn" style="margin-top: 15px; padding: 10px 20px; background: #00ff88; border: none; border-radius: 5px; color: black; font-weight: bold; cursor: pointer;">
            –ü–æ—á–∞—Ç–∏ –≥—Ä—É
        </button>
    </div>

    <!-- üì∑ –°—Ö–æ–≤–∞–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤—ñ–¥–µ–æ –ø–æ—Ç–æ–∫—É -->
    <video id="camera-stream" autoplay muted playsinline style="display:none;"></video>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');
            const instructions = document.getElementById('instructions');
            const photoBtn = document.getElementById('photo-btn');
            const infoBtn = document.getElementById('info-btn');
            const hintMessage = document.getElementById('hint-message');
            const startBtn = document.getElementById('start-btn');

            const lang = navigator.language.startsWith('uk') ? 'uk' : 'en';
            let visibleMarkers = 0;
            const ghosts = [];

            // ‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –ó–ê–î–ù–¨–û–á –∫–∞–º–µ—Ä–∏
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: "environment" } // ‚Üê –ó–ê–î–ù–Ø –ö–ê–ú–ï–†–ê
                }
            })
            .then(stream => {
                const video = document.getElementById('camera-stream');
                video.srcObject = stream;
                video.play();
            })
            .catch(err => {
                console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∑–∞–¥–Ω—å–æ—ó –∫–∞–º–µ—Ä–∏:", err);
                // –°–ø—Ä–æ–±–∞ –∑ –±—É–¥—å-—è–∫–æ—é –∫–∞–º–µ—Ä–æ—é
                return navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        const video = document.getElementById('camera-stream');
                        video.srcObject = stream;
                        video.play();
                    });
            })
            .catch(err => {
                console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∂–æ–¥–Ω—É –∫–∞–º–µ—Ä—É:", err);
                showMessage(lang === 'uk' ? '‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É' : '‚ö†Ô∏è Failed to start camera');
            });

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–∏–≤–∏–¥—ñ–≤ (PNG –∑–∞–º—ñ—Å—Ç—å –µ–º–æ–¥–∂—ñ)
            function createGhost(targetEntity, ghostId) {
                const ghostCount = 5; // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–∏–≤–∏–¥—ñ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ä
                
                for (let i = 0; i < ghostCount; i++) {
                    const ghost = document.createElement('img');
                    ghost.className = 'ghost';
                    ghost.src = `./assets/textures/ghost${Math.floor(Math.random() * 5) + 1}.png`; // PNG –∑ –ø–∞–ø–∫–∏
                    ghost.style.display = 'none';
                    ghost.style.width = `${30 + Math.random() * 50}px`; // –í–∏–ø–∞–¥–∫–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä
                    ghost.style.height = 'auto';
                    ghost.style.pointerEvents = 'none';
                    ghost.style.zIndex = '50';

                    document.body.appendChild(ghost);
                    
                    ghosts.push({
                        element: ghost,
                        targetEntity: targetEntity,
                        offsetX: (Math.random() - 0.5) * 2,
                        offsetY: Math.random() * 2,
                        offsetZ: (Math.random() - 0.5) * 2,
                        speed: 0.5 + Math.random() * 1
                    });
                }
            }

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π –ø—Ä–∏–≤–∏–¥—ñ–≤
            function updateGhosts() {
                ghosts.forEach(ghost => {
                    if (ghost.targetEntity.object3D.visible) {
                        const worldPosition = new THREE.Vector3();
                        ghost.targetEntity.object3D.getWorldPosition(worldPosition);
                        
                        // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ 3D –ø–æ–∑–∏—Ü—ñ—é –≤ 2D –µ–∫—Ä–∞–Ω–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                        const camera = document.querySelector('a-camera').components.camera.camera;
                        const canvas = document.querySelector('a-scene').canvas;
                        
                        worldPosition.x += ghost.offsetX;
                        worldPosition.y += ghost.offsetY;
                        worldPosition.z += ghost.offsetZ;
                        
                        const vector = worldPosition.project(camera);
                        
                        const x = (vector.x * 0.5 + 0.5) * canvas.clientWidth;
                        const y = -(vector.y * 0.5 - 0.5) * canvas.clientHeight;
                        
                        if (vector.z < 1 && x > 0 && x < canvas.clientWidth && y > 0 && y < canvas.clientHeight) {
                            ghost.element.style.display = 'block';
                            ghost.element.style.left = (x - ghost.element.width / 2) + 'px';
                            ghost.element.style.top = (y - ghost.element.height / 2) + 'px';
                            
                            // –ê–Ω—ñ–º–∞—Ü—ñ—è —Ä—É—Ö—É
                            ghost.offsetY += 0.01 * ghost.speed;
                            if (ghost.offsetY > 2) ghost.offsetY = 0;
                        } else {
                            ghost.element.style.display = 'none';
                        }
                    } else {
                        ghost.element.style.display = 'none';
                    }
                });
                
                requestAnimationFrame(updateGhosts);
            }

            // ‚úÖ –û–ù–û–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø ‚Äî –ó–ê–•–û–ü–õ–Æ–Ñ –í–ï–°–¨ –ö–û–ù–¢–ï–ô–ù–ï–† –ó HTML-–ü–†–ò–í–ò–î–ê–ú–ò!
            function takeScreenshot() {
                const flash = document.createElement('div');
                flash.className = 'flash';
                document.body.appendChild(flash);
                
                setTimeout(() => {
                    flash.style.opacity = '0.9';
                    setTimeout(() => {
                        document.body.removeChild(flash);
                    }, 100);
                }, 10);

                setTimeout(() => {
                    // –ó–∞—Ö–æ–ø–ª—é—î–º–æ –≤–µ—Å—å AR-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–≤–∫–ª—é—á–∞—é—á–∏ –ø—Ä–∏–≤–∏–¥—ñ–≤)
                    const appContainer = document.getElementById('app-container');

                    html2canvas(appContainer, {
                        scale: 2, // –ë—ñ–ª—å—à–∞ —è–∫—ñ—Å—Ç—å
                        backgroundColor: null, // –ü—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                        useCORS: true,
                        logging: false,
                        allowTaint: true
                    }).then(canvas => {
                        // –î–æ–¥–∞—î–º–æ —Ç–µ–∫—Å—Ç "Spooky AR Magic"
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = 'rgba(255,255,255,0.8)';
                        ctx.font = 'bold 24px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Spooky AR Magic', canvas.width / 2, 40);

                        // –î–æ–¥–∞—î–º–æ –≤–æ–¥—è–Ω–∏–π –∑–Ω–∞–∫ –∑ –¥–∞—Ç–æ—é
                        ctx.fillStyle = 'rgba(255,255,255,0.5)';
                        ctx.font = 'italic 16px Arial';
                        ctx.textAlign = 'right';
                        ctx.fillText(`¬© ${new Date().toLocaleString()}`, canvas.width - 20, canvas.height - 10);

                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ PNG
                        canvas.toBlob(blob => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `spooky-ar-${Date.now()}.png`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);

                            showMessage(lang === 'uk' ? 'üì∏ –ó–Ω—ñ–º–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!' : 'üì∏ Screenshot saved!');
                        });
                    });
                }, 150);
            }

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
            function showMessage(text) {
                const msg = document.createElement('div');
                msg.className = 'message';
                msg.textContent = text;
                document.body.appendChild(msg);
                
                setTimeout(() => {
                    msg.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(msg);
                    }, 400);
                }, 2000);
            }

            // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
            startBtn.addEventListener('click', () => {
                instructions.style.display = 'none';
                appContainer.style.display = 'block';
                hintMessage.style.display = 'block';
                
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø—Ä–∏–≤–∏–¥—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
                const targetEntities = document.querySelectorAll('.ghost-entity');
                targetEntities.forEach((entity, index) => {
                    createGhost(entity, index + 1);
                });
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø—Ä–∏–≤–∏–¥—ñ–≤
                updateGhosts();
            });

            photoBtn.addEventListener('click', takeScreenshot);
            
            infoBtn.addEventListener('click', () => {
                instructions.style.display = 'block';
            });

            // –°–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π –¥–ª—è –º–∞—Ä–∫–µ—Ä—ñ–≤
            const targetEntities = document.querySelectorAll('[mindar-image-target]');
            
            targetEntities.forEach((entity, index) => {
                entity.addEventListener('targetFound', () => {
                    visibleMarkers++;
                    photoBtn.style.display = 'block';
                    infoBtn.style.display = 'block';
                    
                    hintMessage.textContent = lang === 'uk' 
                        ? `–ú–∞–≥—ñ—è –ø—Ä–∞—Ü—é—î! –ú–∞—Ä–∫–µ—Ä ${index + 1} –∞–∫—Ç–∏–≤–Ω–∏–π ‚ú®` 
                        : `Magic active! Marker ${index + 1} found ‚ú®`;
                        
                    showMessage(lang === 'uk' 
                        ? `üëª –ü—Ä–∏–≤–∏–¥–∏ –∑'—è–≤–∏–ª–∏—Å—è! –ú–∞—Ä–∫–µ—Ä ${index + 1}` 
                        : `üëª Ghosts appeared! Marker ${index + 1}`);
                });

                entity.addEventListener('targetLost', () => {
                    visibleMarkers = Math.max(0, visibleMarkers - 1);
                    
                    if (visibleMarkers === 0) {
                        photoBtn.style.display = 'none';
                        infoBtn.style.display = 'none';
                        hintMessage.textContent = lang === 'uk' 
                            ? "–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –æ–¥–∏–Ω —ñ–∑ —Ç—Ä—å–æ—Ö –º–∞—Ä–∫–µ—Ä—ñ–≤..." 
                            : "Point your camera at one of the three markers...";
                    }
                });
            });

            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á —ñ –ø–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                instructions.style.display = 'block';
            }, 2000);

        });
    </script>
</body>
</html>
